name: RHEL QEMU Automation (ARM64)

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run with tmate debug session'
        required: false
        default: false

jobs:
  build-and-test:
    runs-on: ubuntu-24.04-arm
    env:
      ISO_NAME: rhel-10.0-aarch64-dvd.iso
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore RHEL ISO
        id: cache-iso
        uses: actions/cache/restore@v4
        with:
          path: downloads/${{ env.ISO_NAME }}
          key: rhel-iso-${{ env.ISO_NAME }}

      - name: Install Python Dependencies
        run: |
          pip install -r requirements.txt

      - name: Download ISO (if missing)
        env:
          # SFTP Credentials
          RHEL_SFTP_HOST: ${{ secrets.RHEL_SFTP_HOST }}
          RHEL_SFTP_USER: ${{ secrets.RHEL_SFTP_USER }}
          RHEL_SFTP_PASS: ${{ secrets.RHEL_SFTP_PASS }}
          # Fallback
          RHEL_ISO_URL: ${{ secrets.RHEL_ISO_URL }}
        run: |
          python -u main.py --download-only

      - name: Save RHEL ISO to Cache
        if: steps.cache-iso.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: downloads/${{ env.ISO_NAME }}
          key: rhel-iso-${{ env.ISO_NAME }}

      # Debug session (if enabled)
      - name: Setup tmate session
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

      - name: Install deps & run automation
        env:
          # VM Credentials & Subscription
          RHEL_SSH_USER: ${{ secrets.RHEL_SSH_USER }}
          RHEL_SSH_PASS: ${{ secrets.RHEL_SSH_PASS }}
          RHEL_SUB_USER: ${{ secrets.RHEL_SUB_USER }}
          RHEL_SUB_PASS: ${{ secrets.RHEL_SUB_PASS }}
          RHEL_ISO_URL: "dummy" # already downloaded
        run: |
          chmod +x init_setup.sh
          ./init_setup.sh

      - name: Verify artifacts
        run: |
          test -f disk.qcow2
          test -f install-remastered.iso
          echo "Artifacts present: disk.qcow2, install-remastered.iso"
